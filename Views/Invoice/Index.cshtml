
<header>
    <link rel="stylesheet" href="~/css/Icon.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

</header>

<div class="col-md-12 ">
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white text-center">
            <h4 class="mb-0">Invoice</h4>
        </div>
    </div>
    <form>
        <div class="row">
            <div class="col-md-7  ps-4">
                <div class="card p-3">
                    <h3 class="bg-info text-white">Customer Details</h3>
                    <input type="hidden" class="form-control" id="Id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Name">Name</label>
                                <input type="text" class="form-control" id="Name" placeholder="Enter Customer Name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Phone">Phone</label>
                                <input type="tel" class="form-control" id="Phone" placeholder="Enter Phone Number">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Address">Address</label>
                        <input type="text" class="form-control" id="Address" placeholder="Enter Address">
                    </div>
                </div>
            </div>
 
            <div class="col-md-5 pe-4">
                <div class="card p-3">
                    <h3 class="bg-info text-white">Invoice Details</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Customer_Id">Customer ID</label>
                                <input type="number" class="form-control" id="Customer_Id" placeholder="Enter Customer ID">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="PrintedBy">Printed By</label>
                                <input type="text" class="form-control" id="PrintedBy" placeholder="Enter Printer's Name">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Date">Date</label>
                        <input type="date" class="form-control" id="Date">
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12 px-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h4 class="mb-0 bg-info text-white">Invoice Items</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3 ">
                            <div class="col-md-3">
                                <label>Product Description</label>
                                <input name="Description" class="form-control" placeholder="Product Description" />
                            </div>
                            <div class="col-md-2">
                                <label>Quantity</label>
                                <input name="Quantity" type="number" class="form-control" placeholder="Quantity" />
                            </div>
                            <div class="col-md-2">
                                <label>Unit Price</label>
                                <input name="UnitPrice" type="number" class="form-control" placeholder="Unit Price" />
                            </div>
                            <div class="col-md-2">
                                <label>Discount %</label>
                                <input name="Discount" type="number" class="form-control" placeholder="Discount" />
                            </div>
                            <div class="col-md-2">
                                <label>Total Price</label>
                                <input name="TotalPrice" type="number" class="form-control" placeholder="Total" readonly />
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary m-3" onclick="addItem()">Add Item</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </form>
    <div class="row mt-4">
        <div class="col-12 px-4">
            <div class="row">
                <div class="col-md-8">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-light">
                            <h4 class="mb-0 bg-info text-white">Order List</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th scope="col">Product Description</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Discount</th>
                                            <th scope="col">Total</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-container">
                                       
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-light">
                            <h4 class="mb-0 bg-info text-white">Order Summary</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="subtotal" class="mb-0">Subtotal:</label>
                                    <input type="text" id="subtotal" class="form-control text-end" readonly style="max-width: 120px;">
                                </div>
                            </div>
                            <div class="form-group mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="totalDiscount" class="mb-0">Total Discount:</label>
                                    <input type="text" id="totalDiscount" class="form-control text-end" readonly style="max-width: 120px;">
                                </div>
                            </div>
                            <hr>
                            <div class="form-group mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="ManualDiscount" class="mb-0">Discount:</label>
                                    <input type="text" name="ManualDiscount" id="ManualDiscount" class="form-control text-end" style="max-width: 120px;">
                                </div>
                            </div>
                            <hr />
                            <div class="form-group mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="grandTotal" class="fw-bold mb-0">Grand Total:</label>
                                    <input type="text"id="grandTotal" class="form-control text-end fw-bold" readonly style="max-width: 120px;">
                                </div>
                            </div>
                            <div class="mt-3 d-flex justify-content-center">
                                <button type="button" class="btn btn-success me-2 flex-grow-1">
                                    Save
                                </button>
                                <button type="button" class="btn btn-success flex-grow-1">
                                    Print
                                </button>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>
            let itemIndex = 0;
            let items = [];

            function addItem() {
                // Get values from input fields
                const description = document.querySelector('input[name="Description"]').value;
                const quantity = document.querySelector('input[name="Quantity"]').value;
                const unitPrice = document.querySelector('input[name="UnitPrice"]').value;
                const discount = document.querySelector('input[name="Discount"]').value;

                // Validate inputs
                if (!description || !quantity || !unitPrice) {
                    alert('Please fill in all required fields');
                    return;
                }

                const totalPrice = calculateTotal(quantity, unitPrice, discount);

                // Add item to array
                items.push({
                    description,
                    quantity: parseFloat(quantity),
                    unitPrice: parseFloat(unitPrice),
                    discount: parseFloat(discount) || 0,
                    totalPrice
                });

                // Add item to table
                const newRow = `
                    <tr id="row-${itemIndex}">
                        <td>${description}</td>
                        <td>${quantity}</td>
                        <td>${discount}%</td>
                        <td>${totalPrice.toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeTableItem(${itemIndex})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                document.getElementById('items-container').insertAdjacentHTML('beforeend', newRow);

                // Clear input fields
                clearInputFields();

                // Update totals
                updateOrderSummary();

                itemIndex++;
            }

            function clearInputFields() {
                document.querySelector('input[name="Description"]').value = '';
                document.querySelector('input[name="Quantity"]').value = '';
                document.querySelector('input[name="UnitPrice"]').value = '';
                document.querySelector('input[name="Discount"]').value = '';
                document.querySelector('input[name="TotalPrice"]').value = '';
            }

            function calculateTotal(quantity, unitPrice, discount) {
                const subtotal = quantity * unitPrice;
                const discountAmount = (subtotal * (discount || 0)) / 100;
                return subtotal - discountAmount;
            }

            function removeTableItem(index) {
                items.splice(index, 1);
                document.getElementById(`row-${index}`).remove();
                updateOrderSummary();
            }

            function updateOrderSummary() {
                // Calculate subtotal (sum of quantity * unitPrice for all items)
                const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);

                // Calculate total item-level discounts
                const itemDiscountsTotal = items.reduce((sum, item) => {
                    const itemSubtotal = item.quantity * item.unitPrice;
                    return sum + (itemSubtotal * (item.discount || 0)) / 100;
                }, 0);

                // Get manual discount amount (not percentage)
                let manualDiscount = parseFloat(document.getElementById('ManualDiscount').value) || 0;

                // Ensure manual discount doesn't exceed subtotal minus item discounts
                const maxPossibleDiscount = subtotal - itemDiscountsTotal;
                if (manualDiscount > maxPossibleDiscount) {
                    manualDiscount = maxPossibleDiscount;
                    document.getElementById('ManualDiscount').value = maxPossibleDiscount.toFixed(2);
                }

                // Calculate grand total
                const grandTotal = subtotal - itemDiscountsTotal - manualDiscount;

                // Update display values
                document.getElementById('subtotal').value = subtotal.toFixed(2);
                document.getElementById('totalDiscount').value = itemDiscountsTotal.toFixed(2);
                document.getElementById('grandTotal').value = Math.max(0, grandTotal.toFixed(2));
            }

            // Add event listeners to calculate total price when inputs change
            document.querySelector('input[name="Quantity"]').addEventListener('input', updateTotalPrice);
            document.querySelector('input[name="UnitPrice"]').addEventListener('input', updateTotalPrice);
            document.querySelector('input[name="Discount"]').addEventListener('input', updateTotalPrice);

            // Add event listener for manual discount
            document.getElementById('ManualDiscount').addEventListener('input', function (e) {
                // Only allow positive numbers and up to 2 decimal places
                let value = e.target.value;

                // Remove any characters that aren't numbers or decimal point
                value = value.replace(/[^\d.]/g, '');

                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                // Limit to 2 decimal places
                if (parts.length > 1) {
                    value = parts[0] + '.' + parts[1].slice(0, 2);
                }

                // Update input value and recalculate totals
                e.target.value = value;
                updateOrderSummary();
            });

            function updateTotalPrice() {
                const quantity = parseFloat(document.querySelector('input[name="Quantity"]').value) || 0;
                const unitPrice = parseFloat(document.querySelector('input[name="UnitPrice"]').value) || 0;
                const discount = parseFloat(document.querySelector('input[name="Discount"]').value) || 0;

                const total = calculateTotal(quantity, unitPrice, discount);
                document.querySelector('input[name="TotalPrice"]').value = total.toFixed(2);
            }
        
    </script>
}
